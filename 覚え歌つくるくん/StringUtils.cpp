#include "StringUtils.hpp"

// 伸ばし棒の処理を行わないモーラ分割関数
Array<String> SplitToMoraWithoutLongVowel(const String& input)
{
	Array<String> moraList;

	size_t i = 0;
	while (i < input.size())
	{
		String mora;

		// 1文字目
		mora += input[i];

		// 次の文字が小文字なら、続けて1モーラとする（「っ」以外）
		if (i + 1 < input.size() && (U"ぁぃぅぇぉゃゅょァィゥェォャュョ"_s.includes(input[i + 1])))
		{
			mora += input[i + 1];
			++i;
		}

		moraList << mora;
		++i;

		// 伸ばし棒 'ー' はそのままモーラとして扱う
		// 次の文字が 'ー' なら、次のループで処理される
	}

	return moraList;
}

// 伸ばし棒 'ー' を前のモーラの母音に置き換える関数
void ReplaceLongVowelMarks(Array<Array<Note>>& phrases)
{
	for (auto& phrase : phrases)
	{
		for (size_t i = 0; i < phrase.size(); ++i)
		{
			String& lyric = phrase[i].lyric;

			if (lyric == U"ー")
			{
				// 前のモーラが存在する場合
				if (i > 0)
				{
					const String& previousMora = phrase[i - 1].lyric;
					String vowel = GetVowelFromKana(previousMora);

					// 伸ばし棒を母音に置き換える
					if (!vowel.isEmpty())
					{
						lyric = vowel;
					}
					else
					{
						// 母音が取得できない場合はそのまま 'ー' を残す
					}
				}
				else
				{
					// 前のモーラがない場合はそのまま 'ー' を残す
				}
			}
		}
	}
}


// ひらがな/カタカナから母音を取得する関数
String GetVowelFromKana(const String& kana)
{
	static const HashTable<String, String> vowelMap = {
		// あ行
		{U"あ", U"あ"}, {U"い", U"い"}, {U"う", U"う"}, {U"え", U"え"}, {U"お", U"お"},
		{U"ア", U"ア"}, {U"イ", U"イ"}, {U"ウ", U"ウ"}, {U"エ", U"エ"}, {U"オ", U"オ"},

		// か行
		{U"か", U"あ"}, {U"き", U"い"}, {U"く", U"う"}, {U"け", U"え"}, {U"こ", U"お"},
		{U"カ", U"ア"}, {U"キ", U"イ"}, {U"ク", U"ウ"}, {U"ケ", U"エ"}, {U"コ", U"オ"},

		// きゃ行（拗音）
		{U"きゃ", U"あ"}, {U"きゅ", U"う"}, {U"きょ", U"お"},
		{U"キャ", U"ア"}, {U"キュ", U"ウ"}, {U"キョ", U"オ"},

		// さ行
		{U"さ", U"あ"}, {U"し", U"い"}, {U"す", U"う"}, {U"せ", U"え"}, {U"そ", U"お"},
		{U"サ", U"ア"}, {U"シ", U"イ"}, {U"ス", U"ウ"}, {U"セ", U"エ"}, {U"ソ", U"オ"},

		// しゃ行（拗音）
		{U"しゃ", U"あ"}, {U"しゅ", U"う"}, {U"しょ", U"お"},
		{U"シャ", U"ア"}, {U"シュ", U"ウ"}, {U"ショ", U"オ"},

		// た行
		{U"た", U"あ"}, {U"ち", U"い"}, {U"つ", U"う"}, {U"て", U"え"}, {U"と", U"お"},
		{U"タ", U"ア"}, {U"チ", U"イ"}, {U"ツ", U"ウ"}, {U"テ", U"エ"}, {U"ト", U"オ"},

		// ちゃ行（拗音）
		{U"ちゃ", U"あ"}, {U"ちゅ", U"う"}, {U"ちょ", U"お"},
		{U"チャ", U"ア"}, {U"チュ", U"ウ"}, {U"チョ", U"オ"},

		// な行
		{U"な", U"あ"}, {U"に", U"い"}, {U"ぬ", U"う"}, {U"ね", U"え"}, {U"の", U"お"},
		{U"ナ", U"ア"}, {U"ニ", U"イ"}, {U"ヌ", U"ウ"}, {U"ネ", U"エ"}, {U"ノ", U"オ"},

		// にゃ行（拗音）
		{U"にゃ", U"あ"}, {U"にゅ", U"う"}, {U"にょ", U"お"},
		{U"ニャ", U"ア"}, {U"ニュ", U"ウ"}, {U"ニョ", U"オ"},

		// は行
		{U"は", U"あ"}, {U"ひ", U"い"}, {U"ふ", U"う"}, {U"へ", U"え"}, {U"ほ", U"お"},
		{U"ハ", U"ア"}, {U"ヒ", U"イ"}, {U"フ", U"ウ"}, {U"ヘ", U"エ"}, {U"ホ", U"オ"},

		// ひゃ行（拗音）
		{U"ひゃ", U"あ"}, {U"ひゅ", U"う"}, {U"ひょ", U"お"},
		{U"ヒャ", U"ア"}, {U"ヒュ", U"ウ"}, {U"ヒョ", U"オ"},

		// ま行
		{U"ま", U"あ"}, {U"み", U"い"}, {U"む", U"う"}, {U"め", U"え"}, {U"も", U"お"},
		{U"マ", U"ア"}, {U"ミ", U"イ"}, {U"ム", U"ウ"}, {U"メ", U"エ"}, {U"モ", U"オ"},

		// みゃ行（拗音）
		{U"みゃ", U"あ"}, {U"みゅ", U"う"}, {U"みょ", U"お"},
		{U"ミャ", U"ア"}, {U"ミュ", U"ウ"}, {U"ミョ", U"オ"},

		// や行
		{U"や", U"あ"}, {U"ゆ", U"う"}, {U"よ", U"お"},
		{U"ヤ", U"ア"}, {U"ユ", U"ウ"}, {U"ヨ", U"オ"},

		// ら行
		{U"ら", U"あ"}, {U"り", U"い"}, {U"る", U"う"}, {U"れ", U"え"}, {U"ろ", U"お"},
		{U"ラ", U"ア"}, {U"リ", U"イ"}, {U"ル", U"ウ"}, {U"レ", U"エ"}, {U"ロ", U"オ"},

		// りゃ行（拗音）
		{U"りゃ", U"あ"}, {U"りゅ", U"う"}, {U"りょ", U"お"},
		{U"リャ", U"ア"}, {U"リュ", U"ウ"}, {U"リョ", U"オ"},

		// わ行
		{U"わ", U"あ"}, {U"を", U"お"}, {U"ん", U"ん"},
		{U"ワ", U"ア"}, {U"ヲ", U"オ"}, {U"ン", U"ン"},

		// が行（濁音）
		{U"が", U"あ"}, {U"ぎ", U"い"}, {U"ぐ", U"う"}, {U"げ", U"え"}, {U"ご", U"お"},
		{U"ガ", U"ア"}, {U"ギ", U"イ"}, {U"グ", U"ウ"}, {U"ゲ", U"エ"}, {U"ゴ", U"オ"},

		// ぎゃ行（拗音）
		{U"ぎゃ", U"あ"}, {U"ぎゅ", U"う"}, {U"ぎょ", U"お"},
		{U"ギャ", U"ア"}, {U"ギュ", U"ウ"}, {U"ギョ", U"オ"},

		// ざ行（濁音）
		{U"ざ", U"あ"}, {U"じ", U"い"}, {U"ず", U"う"}, {U"ぜ", U"え"}, {U"ぞ", U"お"},
		{U"ザ", U"ア"}, {U"ジ", U"イ"}, {U"ズ", U"ウ"}, {U"ゼ", U"エ"}, {U"ゾ", U"オ"},

		// じゃ行（拗音）
		{U"じゃ", U"あ"}, {U"じゅ", U"う"}, {U"じょ", U"お"},
		{U"ジャ", U"ア"}, {U"ジュ", U"ウ"}, {U"ジョ", U"オ"},

		// だ行（濁音）
		{U"だ", U"あ"}, {U"ぢ", U"い"}, {U"づ", U"う"}, {U"で", U"え"}, {U"ど", U"お"},
		{U"ダ", U"ア"}, {U"ヂ", U"イ"}, {U"ヅ", U"ウ"}, {U"デ", U"エ"}, {U"ド", U"オ"},

		// ぢゃ行（拗音）
		{U"ぢゃ", U"あ"}, {U"ぢゅ", U"う"}, {U"ぢょ", U"お"},
		{U"ヂャ", U"ア"}, {U"ヂュ", U"ウ"}, {U"ヂョ", U"オ"},

		// ば行（濁音）
		{U"ば", U"あ"}, {U"び", U"い"}, {U"ぶ", U"う"}, {U"べ", U"え"}, {U"ぼ", U"お"},
		{U"バ", U"ア"}, {U"ビ", U"イ"}, {U"ブ", U"ウ"}, {U"ベ", U"エ"}, {U"ボ", U"オ"},

		// びゃ行（拗音）
		{U"びゃ", U"あ"}, {U"びゅ", U"う"}, {U"びょ", U"お"},
		{U"ビャ", U"ア"}, {U"ビュ", U"ウ"}, {U"ビョ", U"オ"},

		// ぱ行（半濁音）
		{U"ぱ", U"あ"}, {U"ぴ", U"い"}, {U"ぷ", U"う"}, {U"ぺ", U"え"}, {U"ぽ", U"お"},
		{U"パ", U"ア"}, {U"ピ", U"イ"}, {U"プ", U"ウ"}, {U"ペ", U"エ"}, {U"ポ", U"オ"},

		// ぴゃ行（拗音）
		{U"ぴゃ", U"あ"}, {U"ぴゅ", U"う"}, {U"ぴょ", U"お"},
		{U"ピャ", U"ア"}, {U"ピュ", U"ウ"}, {U"ピョ", U"オ"},

		// 小書きの母音
		{U"ぁ", U"あ"}, {U"ぃ", U"い"}, {U"ぅ", U"う"}, {U"ぇ", U"え"}, {U"ぉ", U"お"},
		{U"ァ", U"ア"}, {U"ィ", U"イ"}, {U"ゥ", U"ウ"}, {U"ェ", U"エ"}, {U"ォ", U"オ"},

		// 促音（小さい「っ」）
		{U"っ", U""}, {U"ッ", U""},

		// 長音符（伸ばし棒）
		{U"ー", U""},

		// その他の拗音
		{U"う゛ぁ", U"あ"}, {U"う゛ぃ", U"い"}, {U"う゛ぇ", U"え"}, {U"う゛ぉ", U"お"},
		{U"ウ゛ァ", U"ア"}, {U"ウ゛ィ", U"イ"}, {U"ウ゛ェ", U"エ"}, {U"ウ゛ォ", U"オ"},
	};

	// 対応する母音があれば返す
	if (vowelMap.contains(kana))
	{
		return vowelMap.at(kana);
	}

	// 特別な処理: 促音「っ」、長音符「ー」の場合は空文字列を返す
	if (kana == U"っ" || kana == U"ッ" || kana == U"ー")
	{
		return U"";
	}

	// デバッグ用にメッセージを出力（必要に応じて）
	// Print << U"vowelMap に存在しない文字: " << kana;

	return U""; // 対応する母音がない場合は空文字を返す
}

