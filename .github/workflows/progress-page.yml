name: Generate progress page

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  issues: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate progress page
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const repoUrl = `https://github.com/${owner}/${repo}`;
            const readmeUrl = `${repoUrl}/blob/main/README.md`;
            const commitsUrl = `${repoUrl}/commits/main/`;
            const issuesUrl = `${repoUrl}/issues`;
            const releasesUrl = `${repoUrl}/releases`;

            // README（HTML）を取得
            const readme = await github.rest.repos.getReadme({
              owner,
              repo,
              mediaType: { format: 'html' }
            });

            // 最新コミット5件
            const commits = (await github.rest.repos.listCommits({
              owner, repo, per_page: 5
            })).data;

            // オープンIssue 10件
            const issues = (await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 10,
              mediaType: { format: 'html' }   // ★ これを追加
            })).data;
            
            // リリース5件
            const releases = (await github.rest.repos.listReleases({
              owner, repo, per_page: 5
            })).data;

            // 進捗ページ用のHTMLを組み立て
            function escapeHtml(str) {
              if (!str) return '';
              return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            }
            function issueBodyHtml(issue) {
              let html = "";

              if (issue.body_html) {
                html = issue.body_html;     // Markdown → HTML された内容
              } else if (issue.body) {
                html = `<pre>${escapeHtml(issue.body)}</pre>`;
              } else {
                html = '<p>(本文なし)</p>';
              }

              // ★ 画像URL修正  ← これを追加
              return fixImageUrls(html, owner, repo);
            }
            function fixImageUrls(html, owner, repo) {
              if (!html) return html;

              // 1) blob URL → raw URL に変換
              html = html.replace(
                /https:\/\/github\.com\/[^\/]+\/[^\/]+\/blob\/([^"]+)/g,
                (match, p1) => `https://raw.githubusercontent.com/${owner}/${repo}/${p1}`
              );

              // 2) 相対パスの img src="./images/..." を raw URL に
              html = html.replace(
                /<img\s+[^>]*src="([^":]+)"/g,
                (match, p1) =>
                  `<img src="https://raw.githubusercontent.com/${owner}/${repo}/main/${p1}">`
              );

              return html;
            }
            const readmeHtml = fixImageUrls(readme.data, owner, repo);

            let html = `
            <!doctype html>
            <html lang="ja">
            <head>
                <meta charset="utf-8">
                <meta name="viewport" content="width=device-width, initial-scale=1">
                <title>進捗 - 覚え歌つくるくん</title>
                <link rel="icon" href="https://raw.githubusercontent.com/hachi-mori/Memorization-song-creator/d0fff79c991ed7d471319eea26d11bc84a3b941d/%E8%A6%9A%E3%81%88%E6%AD%8C%E3%81%A4%E3%81%8F%E3%82%8B%E3%81%8F%E3%82%93/App/icon.ico" type="image/x-icon">
                <style>
                    /* --- 基本スタイル --- */
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                                     "Hiragino Sans", "Hiragino Kaku Gothic ProN",
                                     "BIZ UDPGothic", Meiryo, sans-serif;
                        /* 方針: 水色〜青のグラデーション */
                        background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%);
                        margin: 0;
                        padding: 24px;
                        color: #333;
                    }

                    h1 {
                        text-align: center;
                        color: #01579b; /* 濃い青 */
                        margin-bottom: 32px;
                    }

                    .container {
                        display: flex;
                        flex-wrap: wrap; /* 画面が狭い場合は折り返す */
                        gap: 24px;
                        max-width: 1400px;
                        margin: 0 auto;
                    }

                    .main-content {
                        flex: 1; /* 左カラム (README) */
                        min-width: 300px; /* 折り返し最小幅 */
                    }

                    .sidebar {
                        flex: 1; /* 右カラム (その他) */
                        min-width: 300px; /* 折り返し最小幅 */
                        display: flex;
                        flex-direction: column;
                        gap: 24px;
                    }

                    /* --- カードUI --- */
                    .card {
                        background: #ffffffcc;
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
                        backdrop-filter: blur(4px);
                    }

                    h2 {
                        font-size: 1.1rem;
                        margin-top: 0;
                        margin-bottom: 12px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .section-link {
                        margin-left: 4px;
                        font-size: 0.9em;
                        text-decoration: none;
                        color: #0288d1;
                    }

                    .section-link:hover {
                        text-decoration: underline;
                    }

                    /* README */
                    .readme-content {
                        margin-top: 16px;
                        max-width: 100%;
                        line-height: 1.7;
                    }

                    .readme-content img {
                        max-width: 100%;
                        height: auto;
                        border-radius: 8px;
                    }

                    .readme-content pre {
                        background: #f5f5f5;
                        padding: 8px 12px;
                        border-radius: 8px;
                        overflow-x: auto;
                    }

                    .readme-content code {
                        background: #f5f5f5;
                        padding: 2px 4px;
                        border-radius: 4px;
                        font-size: 0.9em;
                    }

                    /* アクティビティリスト共通 */
                    .activity-list {
                        list-style: none;
                        margin: 0;
                        padding: 0;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    .activity-list li {
                        display: flex;
                        align-items: flex-start;
                        gap: 8px;
                        font-size: 0.95rem;
                    }

                    .activity-list .icon {
                        font-size: 1.2rem;
                        flex-shrink: 0;
                    }

                    .activity-list .content {
                        flex: 1;
                        min-width: 0;
                    }

                    .item-title {
                        font-weight: 600;
                        margin-bottom: 4px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }

                    .date {
                        font-size: 0.8rem;
                        color: #666;
                        margin-bottom: 2px;
                    }

                    .commit-message {
                        font-size: 0.9rem;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }

                    /* Issue 詳細展開 */
                    .issue-details summary {
                        cursor: pointer;
                        list-style: none;
                        display: block;        /* ← ブロック化して幅を100%に */
                        padding-left: 0;       /* ← 完全左揃え */
                        margin-left: 0;
                        text-align: left;
                    }

                    .issue-details summary::-webkit-details-marker {
                        display: none;
                    }

                    .issue-body {
                        margin-top: 8px;
                        font-size: 0.9rem;
                        line-height: 1.6;
                        overflow-wrap: break-word; /* ← 長い単語やURLを折り返す */
                        padding-left: 0;           /* ← タイトルと同じ位置に揃える */
                    }

                    .issue-body pre,
                    .issue-body code {
                        white-space: pre-wrap;      /* ← コードブロックも折り返し */
                        word-break: break-all;      /* ← 長いコードで横はみ出し防止 */
                        overflow-x: auto;           /* ← 必要なら横スクロール */
                        max-width: 100%;            /* ← 親カード内に収める */
                        box-sizing: border-box;     /* ← パディング込みで幅管理 */
                    }

                    .issue-body img {
                        max-width: 100%;            /* ← 画像がはみ出すのを防ぐ */
                        height: auto;
                        display: block;
                    }

                    /* アイコンとタイトルのズレを揃える */
                    .activity-list li {
                        align-items: flex-start;
                    }

                    .activity-list .icon {
                        margin-top: 4px;  /* ← アイコンとテキスト位置を揃える */
                    }
                    
                    .small-link {
                        display: inline-block;
                        margin-top: 8px;
                        font-size: 0.85rem;
                        color: #0277bd;
                        text-decoration: none;
                    }

                    .small-link:hover {
                        text-decoration: underline;
                    }

                    footer {
                        margin-top: 32px;
                        text-align: center;
                        font-size: 0.85rem;
                        color: #555;
                    }

                    footer a {
                        color: #0277bd;
                        text-decoration: none;
                    }

                    footer a:hover {
                        text-decoration: underline;
                    }

                    /* モバイル対応 (縦に並べる) */
                    @media (max-width: 900px) {
                        .container {
                            flex-direction: column;
                        }
                    }
                </style>
            </head>
            <body>
                <h1>🎵覚え歌つくるくん 進捗ダッシュボード</h1>

                <div class="container">

                    <div class="main-content">
                        <div class="card">
                            <h2>📖 README <a href="${readmeUrl}" class="section-link" target="_blank" rel="noopener">🔗</a></h2>
                            <div class="readme-content">
                                    ${readmeHtml}
                            </div>
                        </div>
                    </div>

                    <div class="sidebar">

                        <div class="card">
                            <h2>📝 最近のコミット <a href="${commitsUrl}" class="section-link" target="_blank" rel="noopener">🔗</a></h2>
                            <ul class="activity-list">
                                ${commits.slice(0, 5).map(c => `
                                <li>
                                    <span class="icon">🧑‍💻</span>
                                    <div class="content">
                                        <span class="date">${new Date(c.commit.author.date).toLocaleDateString('ja-JP')}</span>
                                        <div class="commit-message" title="${escapeHtml(c.commit.message)}">${escapeHtml(c.commit.message)}</div>
                                    </div>
                                </li>
                                `).join('')}
                            </ul>
                        </div>

                        <div class="card">
                            <h2>🐛 オープンIssue <a href="${issuesUrl}" class="section-link" target="_blank" rel="noopener">🔗</a></h2>
                            <ul class="activity-list">
                                ${issues.slice(0, 5).map(i => `
                                <li>
                                    <span class="icon">⚠️</span>
                                    <div class="content">
                                        <details class="issue-details">
                                            <summary class="item-title" title="${escapeHtml(i.title)}">#${i.number} ${escapeHtml(i.title)}</summary>
                                            <div class="issue-body">
                                                ${issueBodyHtml(i)}
                                            </div>
                                            <a href="${i.html_url}" target="_blank" rel="noopener" class="small-link">GitHubで開く</a>
                                        </details>
                                    </div>
                                </li>
                                `).join('')}
                            </ul>
                        </div>

                        <div class="card">
                            <h2>🚀 リリース <a href="${releasesUrl}" class="section-link" target="_blank" rel="noopener">🔗</a></h2>
                            <ul class="activity-list">
                                ${releases.slice(0, 5).map(r => `
                                <li>
                                    <span class="icon">🏷️</span>
                                    <div class="content">
                                        <div class="item-title" title="${escapeHtml(r.name || r.tag_name)}">${escapeHtml(r.name || r.tag_name)}</div>
                                    </div>
                                </li>
                                `).join('')}
                            </ul>
                        </div>

                    </div>
                </div>

                <footer>
                    このダッシュボードは <a href="${repoUrl}" target="_blank" rel="noopener">${owner}/${repo}</a> リポジトリの情報を元に自動生成されています。
                </footer>
            </body>
            </html>
            `;

            // docs/index.html として書き出す
            fs.mkdirSync('docs', { recursive: true });
            fs.writeFileSync(path.join('docs', 'index.html'), html);

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
